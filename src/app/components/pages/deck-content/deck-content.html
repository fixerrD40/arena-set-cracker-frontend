<div class="deck-wrapper" *ngIf="deck">
  <div class="deck-meta">
    <div class="deck-tags">
      <h3>Tags:</h3>
      <mat-chip-grid #chipGrid>
        <mat-chip *ngFor="let tag of deck.tags" (removed)="removeTag(tag)">
          {{ tag }}
          <button matChipRemove>&times;</button>
        </mat-chip>
        <input
          placeholder="New tag..."
          [matChipInputFor]="chipGrid"
          [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
          (matChipInputTokenEnd)="addTag($event)"
        />
      </mat-chip-grid>
    </div>

    <div class="deck-notes">
      <h3>Notes:</h3>
      <textarea [(ngModel)]="deck.notes" (blur)="saveNotes()" rows="4" placeholder="[Add notes]"></textarea>
    </div>

    <div class="deck-recommendations">
      <h3>Recommended Cards:</h3>
      <p *ngIf="loadingRecommendations">Loading recommendations...</p>
      <ul *ngIf="!loadingRecommendations && recommendedCardDetails.length; else noRecs" class="recommended-cards-list">
        <li *ngFor="let card of recommendedCardDetails" class="recommended-card">
          <img *ngIf="card.image_uris?.small" [src]="card.image_uris?.small" [alt]="card.name" class="recommended-card-image" />
          <span class="recommended-card-name">{{ card.name }}</span>
        </li>
      </ul>
      <ng-template #noRecs><p>[blank]</p></ng-template>
    </div>
  </div>

  <div class="deck-list">
    <h2>
      {{ deck.name }}
      <button mat-icon-button (click)="toggleEdit()" aria-label="Edit Deck">
        <mat-icon>edit</mat-icon>
      </button>
    </h2>

    <!-- Conditionally show the edit form -->
    <app-deck-form
      *ngIf="editing"
      [initialValues]="{
        name: deck.name,
        arenaDeck: deck.raw,
        primaryColor: deck.identity.primary,
        colors: deck.identity.colors
      }"
      (submitted)="saveDeck($event)"
      (cancel)="cancelEdit()"
    ></app-deck-form>

    <div class="cards">
      <div
        class="card-box"
        *ngFor="let card of deck.cards | keyvalue"
        [ngxTippy]="getCardTooltip(card.key)"
        [tippyProps]="{ allowHTML: true, placement: 'top', theme: 'light-border' }"
      >
        {{ card.key }} (x{{ card.value }})
      </div>
    </div>
  </div>
</div>
